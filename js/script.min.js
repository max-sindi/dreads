'use strict';var state='step-one',array=['step-one','step-two','step-three','direct-download','email-send','email-download'];handleStepChange(state),document.getElementById('myPortraitSelector').addEventListener('change',function(){handleStepChange('step-two')}),NodeList.prototype.forEach=Array.prototype.forEach,document.querySelectorAll('#goto-step-three').forEach(function(f){f.addEventListener('click',function(){handleStepChange('step-three')})}),document.querySelectorAll('#goto-direct-download').forEach(function(f){f.addEventListener('click',function(){directDownload(),handleStepChange('direct-download')})}),document.querySelectorAll('#goto-email-send').forEach(function(f){f.addEventListener('click',function(){handleStepChange('email-send')})}),document.querySelectorAll('#goto-email-download').forEach(function(f){f.addEventListener('click',function(){handleStepChange('email-download')})});function handleStepChange(f){for(var g=0;g<array.length;g++)document.getElementById(array[g]).style.display=array[g]==f?'block':'none'}function directDownload(){var f=document.createElement('a');f.setAttribute('href',document.getElementById('final-img').src),f.setAttribute('download','myDreadHead.png'),f.click()}var hidden=document.querySelectorAll('.hidden .element');if(!!hidden)for(var i=0,x=hidden.length;i<x;i++)hidden[i].addEventListener('click',function(){hiddenStateChange(hidden[i])});function hiddenStateChange(f){f.classList.toggle('active'),f.classList.contains('active')?(document.querySelector('.step-two').style.marginTop='0',document.querySelector('.step-three').style.marginTop='0'):640>window.innerWidth&&(document.querySelector('.step-two').style.marginTop='-64px',document.querySelector('.step-three').style.marginTop='-64px')}var dreadSelectionArray=['Dreads(1).png','Dreads(2).png','Dreads(3).png','Dreads(4).png','Dreads(5).png','Dreads(6).png','Dreads(7).png','Dreads(8).png','Dreads(9).png','Dreads(10).png','Dreads(11).png','Dreads(12).png','Dreads(13).png','Dreads(14).png','Dreads(15).png','Dreads(16).png','Dreads(17).png','Dreads(18).png','Dreads(19).png','Dreads(20).png','Dreads(21).png','Dreads(22).png','Dreads(23).png','Dreads(24).png'],ftpPathToOrginalDreads='img/dreads/large/',ftpPathToThumbDreads='img/dreads/thumbs/',ftpPathToLogo='img/dreads/',orginalPortraitWidth=0,scaleddownMaxPortraitwidth=0,portraitexiforientation=-1,portraitRotationDegree=0,currentPortraitScale=1,currentRotate=0,transform=detectTransformProp();function detectTransformProp(){for(var g,k,f=$('body'),h=['transform','-webkit-transform','-moz-transform','-ms-transform','-o-transform'],j=0;j<h.length;j++)if(k=h[j],f.css(k)){g=k;break}return g||(console.error('The property "transform" is not supported in this browser'),g='transform'),g}var image=new Image(80,80);image.setAttribute('crossOrigin','anonymous'),image.src=ftpPathToLogo+'logo.png';var portrait=new Image;portrait.setAttribute('crossOrigin','anonymous');var result=new Image;result.setAttribute('crossOrigin','anonymous'),$(function(){function j(k){var l=$('#userPortrait'),m=currentRotate+k;l.css(transform,'rotate('+m+'deg)'),currentRotate=m}(function(){var l=!!navigator.userAgent.match(/Version\/[\d\.]+.*Safari/);l&&function(){var o=$('body'),p=$('\n          <div class="safari-popup__wrap">\n            <div class="safari-popup">\n              We are sorry! The Dread-Your-Head App can work bad with Safari. Please download a real browser such as Chrome or Firefox.\n              <button class="safari-popup__button">OK</button>\n            </div>\n          </div>\n        ');o.append(p),$('.safari-popup__button').click(function(){p.detach()})}()})(),initializeDreadSelectionList(dreadSelectionArray),$('input:file').change(function(){$('#userPortrait').remove();var k=this.files,l='';if(portraitRotationDegree=0,k||(l+='File upload not supported by your browser.'),k&&k[0])for(var o,m=0;m<k.length;m++)o=k[m],/\.(png|jpeg|jpg|gif)$/i.test(o.name)?(portraitexiforientation=-1,readImage(o)):l+=o.name+': Unsupported Image extension\n';l?$('p#errors').html('<p id="errorText" style="color: #d9534f;font-size: 1.2rem">'+l+'<p/>'):$('#errorText').remove()}),$('#zoomplus').on('click',function(){var l=currentPortraitScale+0.15,m=$('#userPortrait'),o=parseFloat(m.css('width')),p=o*l+'px',q=parseFloat(m.css('height')),s=parseFloat(m.css('left'))-(parseInt(p,10)-parseInt(o,10))/2,t=parseFloat(m.css('top'))-(parseInt(q*l+'px',10)-parseInt(q,10))/2;$('#userPortrait').css('width',p),$('#userPortrait').css('top',t),$('#userPortrait').css('left',s)}),$('#zoomminus').on('click',function(){var l=currentPortraitScale-0.15,m=$('#userPortrait'),o=parseFloat(m.css('width')),p=o*l+'px',q=parseFloat(m.css('height')),s=parseFloat(m.css('left'))-(parseInt(p,10)-parseInt(o,10))/2,t=parseFloat(m.css('top'))-(parseInt(q*l+'px',10)-parseInt(q,10))/2;$('#userPortrait').css('width',p),$('#userPortrait').css('top',t),$('#userPortrait').css('left',s)}),$('.btn-circle-up').on('click',function(){var k=document.getElementById('croppingArea').getBoundingClientRect(),l=document.getElementById('userPortrait');if(l){var m=l.getBoundingClientRect(),o=k.top,p=m.top;if(10<p-o){var q=$('#userPortrait');q.css('top',parseFloat(q.css('top'))-10+'px')}}}),$('.btn-circle-down').on('click',function(){var k=$('#userPortrait');k.css('top',parseFloat(k.css('top'))+10+'px')}),$('.btn-circle-left').on('click',function(){var k=$('#userPortrait');k.css('left',parseFloat(k.css('left'))-10+'px')}),$('.btn-circle-right').on('click',function(){var k=$('#userPortrait');k.css('left',parseFloat(k.css('left'))+10+'px')}),$('#btn-circle-rotate-right').on('click',function(){j(90)}),$('#btn-circle-rotate-left').on('click',function(){j(-90)});$('.thumbnail').on('click',function(k){if(k.preventDefault(),0<$('#userPortrait').length){$(this).hasClass('active')||($('.thumbnail').removeClass('active'),$(this).addClass('active')),$('.ui-wrapper img').remove();var l=$(this).find('img').attr('src'),m=l.split('/'),o=m[m.length-1],q=$('<img />',{id:'userDreads',src:ftpPathToOrginalDreads+o,alt:'dreadcanvas'});q.on('load',function(){q.prependTo($('#croppingArea')),$('.ui-wrapper').append('<div id=\'loading\'><p><img src=\'Assets/img/busy.gif\'/> Please Wait</p></div>');var t=0,u=$('#userDreads').width(),v=$('#userDreads').height(),y=300;v>y&&(t=y/v,$('#userDreads').css('height',y),u*=t,$('#userDreads').css('width',u));$('#userDreads').resizable({handles:'ne'}),$('#userDreads').parent().rotatable({rotationCenterOffset:{top:0,left:0}}),$('#userDreads').parent().css('z-index',1),$('#userDreads').parent().draggable({appendTo:'#croppingArea',scroll:!0}),$('.ui-rotatable-handle').prependTo('.ui-wrapper'),$('.btn').removeClass('disabled'),function(){function B(I){F.push(I)}function C(I){function J(M){var N=$('#userDreads'),O=N.closest('.ui-wrapper'),P=O.width(),Q=O.height();N.width(P+H*M),N.height(Q+H*M),O.width(P+H*M),O.height(Q+H*M)}for(var K=0;K<F.length;K++)if(I.pointerId==F[K].pointerId){F[K]=I;break}if(2==F.length){var L=Math.abs(F[0].clientX-F[1].clientX);0<G&&(L>G&&J(1),L<G&&J(-1)),G=L}}function D(I){E(I),2>F.length&&(G=-1)}function E(I){for(var J=0;J<F.length;J++)if(F[J].pointerId==I.pointerId){F.splice(J,1);break}}var F=[],G=-1,H=2;(function(){var I=document.getElementById('userDreads');I.onpointerdown=B,I.onpointermove=C,I.onpointerup=D,I.onpointercancel=D,I.onpointerout=D,I.onpointerleave=D})()}()}),$('#loading').remove()}})});var useBlob=!1;function readImage(f){var g=new FileReader;preRotateImage(f),g.addEventListener('load',function(){portrait.addEventListener('load',function(){var k=$(this),l=$('#croppingArea');l.empty();-1==portraitexiforientation?portraitRotationDegree=0:1==portraitexiforientation?portraitRotationDegree=0:2==portraitexiforientation?portraitRotationDegree=0:3==portraitexiforientation?portraitRotationDegree=180:4==portraitexiforientation?portraitRotationDegree=180:5==portraitexiforientation?portraitRotationDegree=90:6==portraitexiforientation?portraitRotationDegree=90:7==portraitexiforientation?portraitRotationDegree=270:8==portraitexiforientation?portraitRotationDegree=270:void 0;k.prop('id','userPortrait'),l.empty(),l.append(this),function(){k.css({top:'',left:'',width:'',transform:'rotate(0deg)'}),currentRotate=0}(),function(){var p=k.width(),q=l.width();p>q&&k.width(q)}(),640>window.innerWidth&&$('.controls').css('display','flex');var m=$('#userPortrait').width(),o=$('#userPortrait').height();4<portraitexiforientation&&$(this).css('transform','rotate('+portraitRotationDegree+'deg)'),$('#userPortrait').draggable({appendTo:'#croppingArea'}),useBlob}),portrait.src=g.result}),g.readAsDataURL(f)}function initializeDreadSelectionList(f){$.each(f,function(g,h){$('#dreadSelectionList').append('<a href="#" class="thumbnail"><img src="'+ftpPathToThumbDreads+h+'"/></a>')})}function preRotateImage(f){var g=new FileReader;g.addEventListener('load',function(){var h=new DataView(g.result);65496!=h.getUint16(0,!1)&&(portraitexiforientation=-2);for(var l,j=h.byteLength,k=2;k<j;)if(l=h.getUint16(k,!1),k+=2,65505==l){1165519206!=h.getUint32(k+=2,!1)&&(portraitexiforientation=-1);var m=18761==h.getUint16(k+=6,!1);k+=h.getUint32(k+4,m);var o=h.getUint16(k,m);k+=2;for(var p=0;p<o;p++)274==h.getUint16(k+12*p,m)&&(portraitexiforientation=h.getUint16(k+12*p+8,m))}else if(65280!=(65280&l))break;else k+=h.getUint16(k,!1)}),g.readAsArrayBuffer(f)}function getCurrentRotationFixed(f,g){var h,j,k;if(g?(h=document.getElementById(f).parentNode,j=window.getComputedStyle(h,null),k=j.getPropertyValue('-webkit-transform')||j.getPropertyValue('-moz-transform')||j.getPropertyValue('-ms-transform')||j.getPropertyValue('-o-transform')||j.getPropertyValue('transform')||'fail...'):(h=document.getElementById(f),j=window.getComputedStyle(h,null),k=j.getPropertyValue('-webkit-transform')||j.getPropertyValue('-moz-transform')||j.getPropertyValue('-ms-transform')||j.getPropertyValue('-o-transform')||j.getPropertyValue('transform')||'fail...'),'none'!==k){var l=k.split('(')[1];l=l.split(')')[0],l=l.split(',');var m=l[0],o=l[1],p=l[2],q=l[3],r=Math.sqrt(m*m+o*o),s=Math.atan2(o,m);0>s&&(s+=2*Math.PI);var t=Math.round(s*(180/Math.PI))}else var t=0;return t}document.getElementById('btnExport').addEventListener('click',exportPhoto),document.getElementById('mbtnExport').addEventListener('click',exportPhoto);function exportPhoto(){$('.final-logo').css('display','block'),$('.final-sign').css('display','inline-block'),$('.controls').css('display','none'),$('.mobile-buttons').css('display','none'),$('.step-two-portrait').css('background-color','#3c3c3c'),$('.ui-rotatable-handle').css('display','none'),$('.ui-resizable-handle').css('display','none');var f=$('#picture')[0];domtoimage.toPng(f).then(function(g){document.getElementById('final-img').src=g,handleStepChange('step-three')}).then(function(){$('.final-logo').css('display','none'),$('.final-sign').css('display','none'),$('.controls').css('display','inline-block'),640>window.innerWidth&&$('.mobile-buttons').css('display','block'),$('.step-two-portrait').css('background-color','#ececec'),$('.ui-wrapper').css('padding-top','0'),$('.ui-rotatable-handle').css('display','block'),$('.ui-resizable-handle').css('display','block')}).catch(function(g){console.error('oops, something went wrong!',g)})}
